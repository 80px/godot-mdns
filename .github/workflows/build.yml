name: Build godot-mdns

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/build.yml"
  pull_request:
  workflow_dispatch:

jobs:
  # ── Linux x86_64 ────────────────────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target x86_64-unknown-linux-gnu

  # ── Linux arm64 (cross-compiled) ────────────────────────────────────────────
  build-linux-arm64:
    name: Linux arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install aarch64 cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target aarch64-unknown-linux-gnu

  # ── macOS x86_64 + arm64 → universal binary ────────────────────────────────
  build-macos:
    name: macOS universal
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build x86_64 (debug)
        run: cargo build --target x86_64-apple-darwin

      - name: Build arm64 (debug)
        run: cargo build --target aarch64-apple-darwin

      - name: Lipo universal binary (debug)
        run: |
          mkdir -p staged/macos/universal/debug
          lipo -create \
            target/x86_64-apple-darwin/debug/libgodot_mdns.dylib \
            target/aarch64-apple-darwin/debug/libgodot_mdns.dylib \
            -output staged/macos/universal/debug/libgodot_mdns.dylib

  # ── Windows x86_64 (cross-compiled from Linux via MinGW) ───────────────────
  build-windows-x86_64:
    name: Windows x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-mingw-w64-x86-64

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target x86_64-pc-windows-gnu

  # ── iOS arm64 (physical device, static lib) ──────────────────────────────
  build-ios:
    name: iOS arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target aarch64-apple-ios

  # ── Android arm64 + arm32 + x86_64 (via cargo-ndk) ───────────────────
  build-android:
    name: Android arm64 + arm32 + x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Install cargo-ndk
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-ndk
          locked: true

      - name: Build arm64 (debug)
        run: cargo ndk -t arm64-v8a --platform 21 -- build

      - name: Build arm32 (debug)
        run: cargo ndk -t armeabi-v7a --platform 21 -- build

      - name: Build x86_64 (debug)
        run: cargo ndk -t x86_64 --platform 21 -- build
