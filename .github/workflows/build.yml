name: Build godot-mdns

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "android-plugin/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/build.yml"
  pull_request:
  workflow_dispatch:

jobs:
  # ── Linux x86_64 ────────────────────────────────────────────────────────────
  build-linux-x86_64:
    name: Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target x86_64-unknown-linux-gnu

  # ── Linux arm64 (cross-compiled) ────────────────────────────────────────────
  build-linux-arm64:
    name: Linux arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install aarch64 cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target aarch64-unknown-linux-gnu

  # ── macOS x86_64 + arm64 → universal binary ────────────────────────────────
  build-macos:
    name: macOS universal
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build x86_64 (debug)
        run: cargo build --target x86_64-apple-darwin

      - name: Build arm64 (debug)
        run: cargo build --target aarch64-apple-darwin

      - name: Lipo universal binary (debug)
        run: |
          mkdir -p staged/macos/universal/debug
          lipo -create \
            target/x86_64-apple-darwin/debug/libgodot_mdns.dylib \
            target/aarch64-apple-darwin/debug/libgodot_mdns.dylib \
            -output staged/macos/universal/debug/libgodot_mdns.dylib

  # ── Windows x86_64 (cross-compiled from Linux via MinGW) ───────────────────
  build-windows-x86_64:
    name: Windows x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MinGW cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-mingw-w64-x86-64

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target x86_64-pc-windows-gnu

  # ── iOS arm64 (physical device, static lib) ──────────────────────────────
  build-ios:
    name: iOS arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Build (debug)
        run: cargo build --target aarch64-apple-ios

  # ── Android arm64 + arm32 (via cargo-ndk) ─────────────────────────────
  build-android:
    name: Android arm64 + arm32
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          shared-key: godot-mdns

      - name: Install cargo-ndk
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-ndk
          locked: true

      - name: Build arm64 (debug)
        run: cargo ndk -t arm64-v8a --platform 21 -- build

      - name: Build arm32 (debug)
        run: cargo ndk -t armeabi-v7a --platform 21 -- build

  # ── Android MulticastLock Java plugin ────────────────────────────────
  build-android-plugin:
    name: Android MulticastLock plugin
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Godot Android library
        id: cache-godot-aar
        uses: actions/cache@v4
        with:
          path: android-plugin/libs/godot-lib.aar
          key: godot-lib-4.6-stable-aar

      - name: Download Godot Android library
        if: steps.cache-godot-aar.outputs.cache-hit != 'true'
        working-directory: android-plugin
        run: |
          mkdir -p libs
          curl -L -o libs/godot-lib.aar \
            "https://github.com/godotengine/godot/releases/download/4.6-stable/godot-lib.4.6.stable.template_release.aar"

      - uses: gradle/actions/setup-gradle@v4

      - name: Build plugin
        working-directory: android-plugin
        run: gradle assembleRelease

      - name: Stage
        run: |
          mkdir -p staged-plugin
          cp android-plugin/build/outputs/aar/MulticastLockPlugin-release.aar \
             staged-plugin/MulticastLockPlugin.aar

      - uses: actions/upload-artifact@v4
        with:
          name: godot-mdns-android-plugin
          path: staged-plugin/
